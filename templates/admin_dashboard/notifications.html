{% extends 'base.html' %}
{% load static %}

{% block title %}Notifications - Admin Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 flex">
    <!-- Sidebar -->
    <div class="w-64 min-h-screen bg-gray-800 text-white">
        <div class="p-6">
            <h2 class="text-2xl font-bold mb-8">Admin Panel</h2>
            <nav class="space-y-2">
                <a href="{% url 'admin_dashboard:dashboard' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                </a>
                <a href="{% url 'admin_dashboard:user_management' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-users mr-3"></i>Users
                </a>
                <a href="{% url 'admin_dashboard:place_management' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-map-marker-alt mr-3"></i>Places
                </a>
                <a href="{% url 'admin_dashboard:package_management' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-box mr-3"></i>Packages
                </a>
                <a href="{% url 'admin_dashboard:booking_management' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-calendar-check mr-3"></i>Bookings
                </a>
                <a href="{% url 'admin_dashboard:feedback_management' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-comments mr-3"></i>Feedback
                </a>
                <a href="{% url 'admin_dashboard:analytics' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-chart-bar mr-3"></i>Analytics
                </a>
                <a href="{% url 'admin_dashboard:notifications' %}" class="flex items-center px-4 py-3 rounded-lg bg-gray-700">
                    <i class="fas fa-bell mr-3"></i>Notifications
                </a>
                <a href="{% url 'admin_dashboard:bulk_operations' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-tasks mr-3"></i>Bulk Operations
                </a>
                <a href="{% url 'admin_dashboard:data_export' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-download mr-3"></i>Data Export
                </a>
                <a href="{% url 'admin_dashboard:system_settings' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-cog mr-3"></i>Settings
                </a>
                <a href="{% url 'admin_dashboard:audit_logs' %}" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-history mr-3"></i>Audit Logs
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Notifications</h1>
                        <p class="text-gray-600">Manage system notifications and alerts</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="markAllAsRead()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-check mr-2"></i>Mark All as Read
                        </button>
                        <button onclick="openCreateNotificationModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Create Notification
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Content -->
        <div class="flex-1 p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Notifications List -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-900">All Notifications</h3>
                                <div class="flex space-x-2">
                                    <select id="typeFilter" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                        <option value="">All Types</option>
                                        <option value="booking">Booking</option>
                                        <option value="payment">Payment</option>
                                        <option value="feedback">Feedback</option>
                                        <option value="user">User</option>
                                        <option value="system">System</option>
                                        <option value="maintenance">Maintenance</option>
                                    </select>
                                    <select id="priorityFilter" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                        <option value="">All Priorities</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="divide-y divide-gray-200">
                            {% for notification in notifications %}
                            <div class="px-6 py-4 hover:bg-gray-50 notification-item {% if not notification.is_read %}bg-blue-50{% endif %}" data-type="{{ notification.notification_type }}" data-priority="{{ notification.priority }}">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center
                                            {% if notification.notification_type == 'booking' %}bg-blue-100 text-blue-600
                                            {% elif notification.notification_type == 'payment' %}bg-green-100 text-green-600
                                            {% elif notification.notification_type == 'feedback' %}bg-yellow-100 text-yellow-600
                                            {% elif notification.notification_type == 'user' %}bg-purple-100 text-purple-600
                                            {% elif notification.notification_type == 'system' %}bg-red-100 text-red-600
                                            {% elif notification.notification_type == 'maintenance' %}bg-orange-100 text-orange-600
                                            {% endif %}">
                                            {% if notification.notification_type == 'booking' %}
                                                <i class="fas fa-calendar-check text-sm"></i>
                                            {% elif notification.notification_type == 'payment' %}
                                                <i class="fas fa-credit-card text-sm"></i>
                                            {% elif notification.notification_type == 'feedback' %}
                                                <i class="fas fa-comments text-sm"></i>
                                            {% elif notification.notification_type == 'user' %}
                                                <i class="fas fa-user text-sm"></i>
                                            {% elif notification.notification_type == 'system' %}
                                                <i class="fas fa-exclamation-triangle text-sm"></i>
                                            {% elif notification.notification_type == 'maintenance' %}
                                                <i class="fas fa-tools text-sm"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between">
                                            <h4 class="text-sm font-medium text-gray-900">{{ notification.title }}</h4>
                                            <div class="flex items-center space-x-2">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                    {% if notification.priority == 'urgent' %}bg-red-100 text-red-800
                                                    {% elif notification.priority == 'high' %}bg-orange-100 text-orange-800
                                                    {% elif notification.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {{ notification.get_priority_display }}
                                                </span>
                                                {% if notification.is_global %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    Global
                                                </span>
                                                {% endif %}
                                                {% if not notification.is_read %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    New
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1">{{ notification.message }}</p>
                                        <div class="flex items-center justify-between mt-2">
                                            <p class="text-xs text-gray-500">{{ notification.created_at|date:"M d, Y H:i" }}</p>
                                            <div class="flex items-center space-x-2">
                                                {% if not notification.is_read %}
                                                <button onclick="markAsRead({{ notification.id }})" class="text-blue-600 hover:text-blue-800 text-xs">
                                                    <i class="fas fa-check mr-1"></i>Mark as Read
                                                </button>
                                                {% endif %}
                                                <button onclick="deleteNotification({{ notification.id }})" class="text-red-600 hover:text-red-800 text-xs">
                                                    <i class="fas fa-trash mr-1"></i>Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="px-6 py-8 text-center">
                                <i class="fas fa-bell text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">No notifications found</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- Create Notification -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Create Notification</h3>
                        <form method="post" class="space-y-4">
                            {% csrf_token %}
                            <input type="hidden" name="create_notification" value="true">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                <input type="text" name="title" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                                <textarea name="message" rows="3" required class="w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                <select name="notification_type" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="booking">Booking</option>
                                    <option value="payment">Payment</option>
                                    <option value="feedback">Feedback</option>
                                    <option value="user">User</option>
                                    <option value="system">System</option>
                                    <option value="maintenance">Maintenance</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                                <select name="priority" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Target Admin</label>
                                <select name="target_admin" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                    <option value="">All Admins (Global)</option>
                                    <!-- Add admin users here -->
                                </select>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="is_global" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                <label class="ml-2 text-sm text-gray-700">Global notification</label>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Create Notification
                            </button>
                        </form>
                    </div>

                    <!-- Notification Stats -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistics</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Total Notifications:</span>
                                <span class="text-sm font-medium">{{ notifications|length }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Unread:</span>
                                <span class="text-sm font-medium text-blue-600">{{ unread_count }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Urgent:</span>
                                <span class="text-sm font-medium text-red-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Today:</span>
                                <span class="text-sm font-medium text-green-600">{{ notifications|length }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                        <div class="space-y-2">
                            <button onclick="markAllAsRead()" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded">
                                <i class="fas fa-check mr-2"></i>Mark All as Read
                            </button>
                            <button onclick="clearOldNotifications()" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded">
                                <i class="fas fa-trash mr-2"></i>Clear Old Notifications
                            </button>
                            <button onclick="exportNotifications()" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded">
                                <i class="fas fa-download mr-2"></i>Export Notifications
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Mark notification as read
function markAsRead(notificationId) {
    fetch(`/admin/api/notifications/${notificationId}/mark-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

// Mark all as read
function markAllAsRead() {
    if (confirm('Mark all notifications as read?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="mark_read" value="true">
            ${Array.from(document.querySelectorAll('input[name="notification_ids"]')).map(input => input.outerHTML).join('')}
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

// Delete notification
function deleteNotification(notificationId) {
    if (confirm('Delete this notification?')) {
        // Implement delete functionality
        console.log('Delete notification:', notificationId);
    }
}

// Clear old notifications
function clearOldNotifications() {
    if (confirm('Clear notifications older than 30 days?')) {
        // Implement clear functionality
        console.log('Clear old notifications');
    }
}

// Export notifications
function exportNotifications() {
    // Implement export functionality
    console.log('Export notifications');
}

// Filter notifications
document.getElementById('typeFilter').addEventListener('change', function() {
    filterNotifications();
});

document.getElementById('priorityFilter').addEventListener('change', function() {
    filterNotifications();
});

function filterNotifications() {
    const typeFilter = document.getElementById('typeFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    const items = document.querySelectorAll('.notification-item');
    
    items.forEach(item => {
        const type = item.dataset.type;
        const priority = item.dataset.priority;
        
        let show = true;
        
        if (typeFilter && type !== typeFilter) {
            show = false;
        }
        
        if (priorityFilter && priority !== priorityFilter) {
            show = false;
        }
        
        item.style.display = show ? 'block' : 'none';
    });
}

// Auto-refresh notifications
setInterval(function() {
    // Check for new notifications
    fetch('/admin/api/notifications/count/')
        .then(response => response.json())
        .then(data => {
            if (data.count > 0) {
                // Show notification badge or refresh
                console.log('New notifications:', data.count);
            }
        });
}, 30000); // Check every 30 seconds
</script>
{% endblock %}
